<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Graphs</title>
  <style type="text/css">
    body {margin: 0}
    #map {display: block;background: #eee}
    #legend {position:absolute;top:0;left:0}
  </style>
</head>

<body>
  <canvas id="map" width="400" height="300"></canvas>
  <div id="legend"></div>
  <script>
    map.width=window.innerWidth;
    map.height=window.innerHeight;
    map.style.width = `${map.width}px`;
    map.style.height = `${map.height}px`;

    const ctx = map.getContext('2d');

    ctx.lineWidth = 1;
    ctx.strokeStyle = '#00ffff';
    ctx.fillStyle = '#ffff00';

    const TRAM_ROUTE = '0';
    const BUS_ROUTE = '3';
    const AGENCY_COLORS = {
      2: 'rgba(0,   0, 0, 0.25)',
      4: 'rgba(255, 0, 0, 0.25)',
      5: 'rgba(0, 255, 0, 0.25)',
      6: 'rgba(0, 0, 255, 0.25)',
      7: 'rgba(255, 255, 0, 0.25)',
      8: 'rgba(255, 0, 255, 0.25)',
      9: 'rgba(0, 255, 255, 0.25)',
      10: 'rgba(127, 0, 0, 0.25)',
      11: 'rgba(0, 127, 0, 0.25)',
      12: 'rgba(0, 0, 127, 0.25)',
    }

    //  lat and long are x and y

    function parseShapes([shapesParsed, agencies]){
      const { minX, minY, maxX, maxY, shapes, routes } = shapesParsed;
      const mapWidth = maxX - minX;
      const mapHeight = maxY - minY;
      const mapCenterX = (maxX + minX) / 2;
      const mapCenterY = (maxY + minY) / 2;
      const scale = Math.min(map.width / mapWidth, map.height / mapHeight);

      shapes
        .sort((a,b) => b.agency - a.agency) // mpk on top
        .forEach(({id, points, agency, routeIds}) => {
          const isBus = routeIds.some((routeId)=> routes[routeId].route_type == BUS_ROUTE);
          const isTram = routeIds.some((routeId)=> routes[routeId].route_type == TRAM_ROUTE);

          ctx.beginPath();
          ctx.strokeStyle = AGENCY_COLORS[agency];
          ctx.lineWidth = isBus ? 1 : 4;
          ctx.setLineDash(isBus ? []: [5,5]);
          points.forEach(([x,y]) => {
            ctx.lineTo(
              (x - mapCenterX) * scale + map.width / 2,
              (y - mapCenterY) * scale + map.height / 2
            );
          })
          ctx.stroke();
        });

        agencies.forEach(agency => {
          const el = document.createElement('div');
          el.textContent = agency.agency_name;
          el.style.color = AGENCY_COLORS[agency.agency_id];
          legend.appendChild(el);
        })


    }

    Promise
      .all([
        fetch('shapesParsed.json').then(resp => resp.json()),
        fetch('db/agency.json').then(resp => resp.json()),
      ])
      .then(parseShapes);

  </script>
</body>

</html>
